.class Lfreemarker/ext/dom/SunInternalXalanXPathSupport;
.super Ljava/lang/Object;
.source "SunInternalXalanXPathSupport.java"

# interfaces
.implements Lfreemarker/ext/dom/XPathSupport;


# static fields
.field private static final ERRMSG_EMPTY_NODE_SET:Ljava/lang/String; = "Cannot perform an XPath query against an empty node set.(Note that there is no such restriction if you configure FreeMarker to use Jaxen instead of Xalan.)"

.field private static final ERRMSG_RECOMMEND_JAXEN:Ljava/lang/String; = "(Note that there is no such restriction if you configure FreeMarker to use Jaxen instead of Xalan.)"

.field private static customPrefixResolver:Lcom/sun/org/apache/xml/internal/utils/PrefixResolver;


# instance fields
.field private xpathContext:Lcom/sun/org/apache/xpath/internal/XPathContext;


# direct methods
.method static constructor <clinit>()V
    .locals 1

    .line 103
    new-instance v0, Lfreemarker/ext/dom/SunInternalXalanXPathSupport$1;

    invoke-direct {v0}, Lfreemarker/ext/dom/SunInternalXalanXPathSupport$1;-><init>()V

    sput-object v0, Lfreemarker/ext/dom/SunInternalXalanXPathSupport;->customPrefixResolver:Lcom/sun/org/apache/xml/internal/utils/PrefixResolver;

    return-void
.end method

.method constructor <init>()V
    .locals 1

    .line 35
    invoke-direct {p0}, Ljava/lang/Object;-><init>()V

    .line 37
    new-instance v0, Lcom/sun/org/apache/xpath/internal/XPathContext;

    invoke-direct {v0}, Lcom/sun/org/apache/xpath/internal/XPathContext;-><init>()V

    iput-object v0, p0, Lfreemarker/ext/dom/SunInternalXalanXPathSupport;->xpathContext:Lcom/sun/org/apache/xpath/internal/XPathContext;

    return-void
.end method

.method private static isNodeList(Ljava/lang/Object;)Z
    .locals 5
    .param p0, "context"    # Ljava/lang/Object;

    .line 129
    instance-of v0, p0, Ljava/util/List;

    const/4 v1, 0x0

    if-eqz v0, :cond_2

    .line 130
    move-object v0, p0

    check-cast v0, Ljava/util/List;

    .line 131
    .local v0, "ls":Ljava/util/List;
    invoke-interface {v0}, Ljava/util/List;->size()I

    move-result v2

    .line 132
    .local v2, "ln":I
    const/4 v3, 0x0

    .local v3, "i":I
    :goto_0
    if-ge v3, v2, :cond_1

    .line 133
    invoke-interface {v0, v3}, Ljava/util/List;->get(I)Ljava/lang/Object;

    move-result-object v4

    instance-of v4, v4, Lorg/w3c/dom/Node;

    if-nez v4, :cond_0

    .line 134
    return v1

    .line 132
    :cond_0
    add-int/lit8 v3, v3, 0x1

    goto :goto_0

    .line 137
    .end local v3    # "i":I
    :cond_1
    const/4 v1, 0x1

    return v1

    .line 139
    .end local v0    # "ls":Ljava/util/List;
    .end local v2    # "ln":I
    :cond_2
    return v1
.end method


# virtual methods
.method public declared-synchronized executeQuery(Ljava/lang/Object;Ljava/lang/String;)Lfreemarker/template/TemplateModel;
    .locals 9
    .param p1, "context"    # Ljava/lang/Object;
    .param p2, "xpathQuery"    # Ljava/lang/String;
    .annotation system Ldalvik/annotation/Throws;
        value = {
            Lfreemarker/template/TemplateModelException;
        }
    .end annotation

    monitor-enter p0

    .line 47
    :try_start_0
    instance-of v0, p1, Lorg/w3c/dom/Node;

    if-nez v0, :cond_3

    .line 48
    if-eqz p1, :cond_2

    .line 49
    invoke-static {p1}, Lfreemarker/ext/dom/SunInternalXalanXPathSupport;->isNodeList(Ljava/lang/Object;)Z

    move-result v0

    if-eqz v0, :cond_1

    .line 50
    move-object v0, p1

    check-cast v0, Ljava/util/List;

    invoke-interface {v0}, Ljava/util/List;->size()I

    move-result v0

    .line 51
    .local v0, "cnt":I
    if-eqz v0, :cond_0

    .line 52
    new-instance v1, Lfreemarker/template/TemplateModelException;

    new-instance v2, Ljava/lang/StringBuilder;

    invoke-direct {v2}, Ljava/lang/StringBuilder;-><init>()V

    const-string v3, "Cannot perform an XPath query against a node set of "

    invoke-virtual {v2, v3}, Ljava/lang/StringBuilder;->append(Ljava/lang/String;)Ljava/lang/StringBuilder;

    move-result-object v2

    invoke-virtual {v2, v0}, Ljava/lang/StringBuilder;->append(I)Ljava/lang/StringBuilder;

    move-result-object v2

    const-string v3, " nodes. Expecting a single node."

    invoke-virtual {v2, v3}, Ljava/lang/StringBuilder;->append(Ljava/lang/String;)Ljava/lang/StringBuilder;

    move-result-object v2

    const-string v3, "(Note that there is no such restriction if you configure FreeMarker to use Jaxen instead of Xalan.)"

    invoke-virtual {v2, v3}, Ljava/lang/StringBuilder;->append(Ljava/lang/String;)Ljava/lang/StringBuilder;

    move-result-object v2

    invoke-virtual {v2}, Ljava/lang/StringBuilder;->toString()Ljava/lang/String;

    move-result-object v2

    invoke-direct {v1, v2}, Lfreemarker/template/TemplateModelException;-><init>(Ljava/lang/String;)V

    throw v1

    .line 56
    .end local p0    # "this":Lfreemarker/ext/dom/SunInternalXalanXPathSupport;
    :cond_0
    new-instance v1, Lfreemarker/template/TemplateModelException;

    const-string v2, "Cannot perform an XPath query against an empty node set.(Note that there is no such restriction if you configure FreeMarker to use Jaxen instead of Xalan.)"

    invoke-direct {v1, v2}, Lfreemarker/template/TemplateModelException;-><init>(Ljava/lang/String;)V

    throw v1

    .line 59
    .end local v0    # "cnt":I
    :cond_1
    new-instance v0, Lfreemarker/template/TemplateModelException;

    new-instance v1, Ljava/lang/StringBuilder;

    invoke-direct {v1}, Ljava/lang/StringBuilder;-><init>()V

    const-string v2, "Cannot perform an XPath query against a "

    invoke-virtual {v1, v2}, Ljava/lang/StringBuilder;->append(Ljava/lang/String;)Ljava/lang/StringBuilder;

    move-result-object v1

    .line 60
    invoke-virtual {p1}, Ljava/lang/Object;->getClass()Ljava/lang/Class;

    move-result-object v2

    invoke-virtual {v2}, Ljava/lang/Class;->getName()Ljava/lang/String;

    move-result-object v2

    invoke-virtual {v1, v2}, Ljava/lang/StringBuilder;->append(Ljava/lang/String;)Ljava/lang/StringBuilder;

    move-result-object v1

    const-string v2, ". Expecting a single org.w3c.dom.Node."

    invoke-virtual {v1, v2}, Ljava/lang/StringBuilder;->append(Ljava/lang/String;)Ljava/lang/StringBuilder;

    move-result-object v1

    invoke-virtual {v1}, Ljava/lang/StringBuilder;->toString()Ljava/lang/String;

    move-result-object v1

    invoke-direct {v0, v1}, Lfreemarker/template/TemplateModelException;-><init>(Ljava/lang/String;)V

    throw v0

    .line 64
    :cond_2
    new-instance v0, Lfreemarker/template/TemplateModelException;

    const-string v1, "Cannot perform an XPath query against an empty node set.(Note that there is no such restriction if you configure FreeMarker to use Jaxen instead of Xalan.)"

    invoke-direct {v0, v1}, Lfreemarker/template/TemplateModelException;-><init>(Ljava/lang/String;)V

    throw v0

    .line 67
    :cond_3
    move-object v0, p1

    check-cast v0, Lorg/w3c/dom/Node;
    :try_end_0
    .catchall {:try_start_0 .. :try_end_0} :catchall_0

    .line 69
    .local v0, "node":Lorg/w3c/dom/Node;
    :try_start_1
    new-instance v7, Lcom/sun/org/apache/xpath/internal/XPath;

    const/4 v3, 0x0

    sget-object v4, Lfreemarker/ext/dom/SunInternalXalanXPathSupport;->customPrefixResolver:Lcom/sun/org/apache/xml/internal/utils/PrefixResolver;

    const/4 v5, 0x0

    const/4 v6, 0x0

    move-object v1, v7

    move-object v2, p2

    invoke-direct/range {v1 .. v6}, Lcom/sun/org/apache/xpath/internal/XPath;-><init>(Ljava/lang/String;Ljavax/xml/transform/SourceLocator;Lcom/sun/org/apache/xml/internal/utils/PrefixResolver;ILjavax/xml/transform/ErrorListener;)V

    move-object v1, v7

    .line 70
    .local v1, "xpath":Lcom/sun/org/apache/xpath/internal/XPath;
    iget-object v2, p0, Lfreemarker/ext/dom/SunInternalXalanXPathSupport;->xpathContext:Lcom/sun/org/apache/xpath/internal/XPathContext;

    invoke-virtual {v2, v0}, Lcom/sun/org/apache/xpath/internal/XPathContext;->getDTMHandleFromNode(Lorg/w3c/dom/Node;)I

    move-result v2

    .line 71
    .local v2, "ctxtNode":I
    iget-object v3, p0, Lfreemarker/ext/dom/SunInternalXalanXPathSupport;->xpathContext:Lcom/sun/org/apache/xpath/internal/XPathContext;

    sget-object v4, Lfreemarker/ext/dom/SunInternalXalanXPathSupport;->customPrefixResolver:Lcom/sun/org/apache/xml/internal/utils/PrefixResolver;

    invoke-virtual {v1, v3, v2, v4}, Lcom/sun/org/apache/xpath/internal/XPath;->execute(Lcom/sun/org/apache/xpath/internal/XPathContext;ILcom/sun/org/apache/xml/internal/utils/PrefixResolver;)Lcom/sun/org/apache/xpath/internal/objects/XObject;

    move-result-object v3

    .line 72
    .local v3, "xresult":Lcom/sun/org/apache/xpath/internal/objects/XObject;
    instance-of v4, v3, Lcom/sun/org/apache/xpath/internal/objects/XNodeSet;

    if-eqz v4, :cond_7

    .line 73
    new-instance v4, Lfreemarker/ext/dom/NodeListModel;

    invoke-direct {v4, v0}, Lfreemarker/ext/dom/NodeListModel;-><init>(Lorg/w3c/dom/Node;)V

    .line 74
    .local v4, "result":Lfreemarker/ext/dom/NodeListModel;
    iput-object p0, v4, Lfreemarker/ext/dom/NodeListModel;->xpathSupport:Lfreemarker/ext/dom/XPathSupport;

    .line 75
    invoke-virtual {v3}, Lcom/sun/org/apache/xpath/internal/objects/XObject;->nodeset()Lorg/w3c/dom/traversal/NodeIterator;

    move-result-object v5

    .line 78
    .local v5, "nodeIterator":Lorg/w3c/dom/traversal/NodeIterator;
    :cond_4
    invoke-interface {v5}, Lorg/w3c/dom/traversal/NodeIterator;->nextNode()Lorg/w3c/dom/Node;

    move-result-object v6

    .line 79
    .local v6, "n":Lorg/w3c/dom/Node;
    if-eqz v6, :cond_5

    .line 80
    invoke-virtual {v4, v6}, Lfreemarker/ext/dom/NodeListModel;->add(Ljava/lang/Object;)V

    .line 82
    :cond_5
    if-nez v6, :cond_4

    .line 83
    invoke-virtual {v4}, Lfreemarker/ext/dom/NodeListModel;->size()I

    move-result v7

    const/4 v8, 0x1

    if-ne v7, v8, :cond_6

    const/4 v7, 0x0

    invoke-virtual {v4, v7}, Lfreemarker/ext/dom/NodeListModel;->get(I)Lfreemarker/template/TemplateModel;

    move-result-object v7
    :try_end_1
    .catch Ljavax/xml/transform/TransformerException; {:try_start_1 .. :try_end_1} :catch_0
    .catchall {:try_start_1 .. :try_end_1} :catchall_0

    goto :goto_0

    :cond_6
    move-object v7, v4

    :goto_0
    monitor-exit p0

    return-object v7

    .line 85
    .end local v4    # "result":Lfreemarker/ext/dom/NodeListModel;
    .end local v5    # "nodeIterator":Lorg/w3c/dom/traversal/NodeIterator;
    .end local v6    # "n":Lorg/w3c/dom/Node;
    :cond_7
    :try_start_2
    instance-of v4, v3, Lcom/sun/org/apache/xpath/internal/objects/XBoolean;

    if-eqz v4, :cond_9

    .line 86
    move-object v4, v3

    check-cast v4, Lcom/sun/org/apache/xpath/internal/objects/XBoolean;

    invoke-virtual {v4}, Lcom/sun/org/apache/xpath/internal/objects/XBoolean;->bool()Z

    move-result v4

    if-eqz v4, :cond_8

    sget-object v4, Lfreemarker/template/TemplateBooleanModel;->TRUE:Lfreemarker/template/TemplateBooleanModel;

    goto :goto_1

    :cond_8
    sget-object v4, Lfreemarker/template/TemplateBooleanModel;->FALSE:Lfreemarker/template/TemplateBooleanModel;
    :try_end_2
    .catch Ljavax/xml/transform/TransformerException; {:try_start_2 .. :try_end_2} :catch_0
    .catchall {:try_start_2 .. :try_end_2} :catchall_0

    :goto_1
    monitor-exit p0

    return-object v4

    .line 88
    :cond_9
    :try_start_3
    instance-of v4, v3, Lcom/sun/org/apache/xpath/internal/objects/XNull;
    :try_end_3
    .catch Ljavax/xml/transform/TransformerException; {:try_start_3 .. :try_end_3} :catch_0
    .catchall {:try_start_3 .. :try_end_3} :catchall_0

    if-eqz v4, :cond_a

    .line 89
    const/4 v4, 0x0

    monitor-exit p0

    return-object v4

    .line 91
    :cond_a
    :try_start_4
    instance-of v4, v3, Lcom/sun/org/apache/xpath/internal/objects/XString;

    if-eqz v4, :cond_b

    .line 92
    new-instance v4, Lfreemarker/template/SimpleScalar;

    invoke-virtual {v3}, Lcom/sun/org/apache/xpath/internal/objects/XObject;->toString()Ljava/lang/String;

    move-result-object v5

    invoke-direct {v4, v5}, Lfreemarker/template/SimpleScalar;-><init>(Ljava/lang/String;)V
    :try_end_4
    .catch Ljavax/xml/transform/TransformerException; {:try_start_4 .. :try_end_4} :catch_0
    .catchall {:try_start_4 .. :try_end_4} :catchall_0

    monitor-exit p0

    return-object v4

    .line 94
    :cond_b
    :try_start_5
    instance-of v4, v3, Lcom/sun/org/apache/xpath/internal/objects/XNumber;

    if-eqz v4, :cond_c

    .line 95
    new-instance v4, Lfreemarker/template/SimpleNumber;

    new-instance v5, Ljava/lang/Double;

    move-object v6, v3

    check-cast v6, Lcom/sun/org/apache/xpath/internal/objects/XNumber;

    invoke-virtual {v6}, Lcom/sun/org/apache/xpath/internal/objects/XNumber;->num()D

    move-result-wide v6

    invoke-direct {v5, v6, v7}, Ljava/lang/Double;-><init>(D)V

    invoke-direct {v4, v5}, Lfreemarker/template/SimpleNumber;-><init>(Ljava/lang/Number;)V
    :try_end_5
    .catch Ljavax/xml/transform/TransformerException; {:try_start_5 .. :try_end_5} :catch_0
    .catchall {:try_start_5 .. :try_end_5} :catchall_0

    monitor-exit p0

    return-object v4

    .line 97
    :cond_c
    :try_start_6
    new-instance v4, Lfreemarker/template/TemplateModelException;

    new-instance v5, Ljava/lang/StringBuilder;

    invoke-direct {v5}, Ljava/lang/StringBuilder;-><init>()V

    const-string v6, "Cannot deal with type: "

    invoke-virtual {v5, v6}, Ljava/lang/StringBuilder;->append(Ljava/lang/String;)Ljava/lang/StringBuilder;

    move-result-object v5

    invoke-virtual {v3}, Ljava/lang/Object;->getClass()Ljava/lang/Class;

    move-result-object v6

    invoke-virtual {v6}, Ljava/lang/Class;->getName()Ljava/lang/String;

    move-result-object v6

    invoke-virtual {v5, v6}, Ljava/lang/StringBuilder;->append(Ljava/lang/String;)Ljava/lang/StringBuilder;

    move-result-object v5

    invoke-virtual {v5}, Ljava/lang/StringBuilder;->toString()Ljava/lang/String;

    move-result-object v5

    invoke-direct {v4, v5}, Lfreemarker/template/TemplateModelException;-><init>(Ljava/lang/String;)V

    .end local v0    # "node":Lorg/w3c/dom/Node;
    .end local p1    # "context":Ljava/lang/Object;
    .end local p2    # "xpathQuery":Ljava/lang/String;
    throw v4
    :try_end_6
    .catch Ljavax/xml/transform/TransformerException; {:try_start_6 .. :try_end_6} :catch_0
    .catchall {:try_start_6 .. :try_end_6} :catchall_0

    .line 98
    .end local v1    # "xpath":Lcom/sun/org/apache/xpath/internal/XPath;
    .end local v2    # "ctxtNode":I
    .end local v3    # "xresult":Lcom/sun/org/apache/xpath/internal/objects/XObject;
    .restart local v0    # "node":Lorg/w3c/dom/Node;
    .restart local p1    # "context":Ljava/lang/Object;
    .restart local p2    # "xpathQuery":Ljava/lang/String;
    :catch_0
    move-exception v1

    .line 99
    .local v1, "te":Ljavax/xml/transform/TransformerException;
    :try_start_7
    new-instance v2, Lfreemarker/template/TemplateModelException;

    invoke-direct {v2, v1}, Lfreemarker/template/TemplateModelException;-><init>(Ljava/lang/Exception;)V

    throw v2
    :try_end_7
    .catchall {:try_start_7 .. :try_end_7} :catchall_0

    .line 46
    .end local v0    # "node":Lorg/w3c/dom/Node;
    .end local v1    # "te":Ljavax/xml/transform/TransformerException;
    .end local p1    # "context":Ljava/lang/Object;
    .end local p2    # "xpathQuery":Ljava/lang/String;
    :catchall_0
    move-exception p1

    monitor-exit p0

    throw p1
.end method
